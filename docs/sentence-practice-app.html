<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanskbert - Meningstr√§ning</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .back-btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 16px; background: rgba(255,255,255,0.1);
            border: none; border-radius: 10px; color: #888;
            font-size: 0.95rem; cursor: pointer; transition: all 0.2s;
            text-decoration: none; margin-bottom: 20px;
        }
        .back-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
        header { text-align: center; padding: 20px 0 30px; }
        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #1abc9c, #16a085);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 8px;
        }
        header p { color: #888; font-size: 1rem; }
        .stats-overview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
        .stat-card { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 18px 12px; text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: bold; }
        .stat-value.sessions { color: #1abc9c; }
        .stat-value.correct { color: #2ecc71; }
        .stat-value.streak { color: #f39c12; }
        .stat-label { font-size: 0.8rem; color: #888; margin-top: 5px; }
        .main-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .main-btn {
            padding: 18px 20px; border: none; border-radius: 15px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .main-btn.primary { background: linear-gradient(90deg, #1abc9c, #16a085); color: #fff; }
        .main-btn.secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .main-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .section-title { font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; }
        .categories-list { display: flex; flex-direction: column; gap: 10px; }
        .category-group { margin-bottom: 15px; }
        .category-group-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 18px; background: rgba(255,255,255,0.08);
            border-radius: 12px; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;
        }
        .category-group-header:hover { background: rgba(255,255,255,0.12); }
        .category-group-title { display: flex; align-items: center; gap: 10px; font-size: 1rem; font-weight: 600; color: #fff; }
        .category-group-title .group-icon { font-size: 1.2rem; }
        .category-group-count { color: #888; font-size: 0.85rem; }
        .category-group-arrow { color: #666; font-size: 1.2rem; transition: transform 0.3s; }
        .category-group.expanded .category-group-arrow { transform: rotate(180deg); }
        .category-group-items { display: none; flex-direction: column; gap: 8px; padding-left: 12px; }
        .category-group.expanded .category-group-items { display: flex; }
        .category-item {
            display: flex; align-items: center; padding: 16px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 15px; cursor: pointer; transition: all 0.2s;
        }
        .category-item:hover { background: rgba(255,255,255,0.08); transform: translateX(5px); }
        .category-icon {
            width: 50px; height: 50px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; margin-right: 15px; flex-shrink: 0;
        }
        .category-info { flex: 1; }
        .category-name { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
        .category-count { font-size: 0.9rem; color: #888; }
        .progress-circle { width: 45px; height: 45px; }
        .progress-circle svg { transform: rotate(-90deg); }
        .progress-circle .bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 4; }
        .progress-circle .progress { fill: none; stroke: #2ecc71; stroke-width: 4; stroke-linecap: round; }
        .exercise-view { display: none; }
        .exercise-view.active { display: block; }
        .category-view { display: block; }
        .category-view.hidden { display: none; }
        .exercise-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .exercise-title { font-size: 1.3rem; font-weight: 600; }
        .exercise-progress-text { color: #888; font-size: 0.95rem; }
        .stats-bar { display: flex; justify-content: center; gap: 25px; margin-bottom: 25px; }
        .stat { text-align: center; padding: 12px 20px; background: rgba(255,255,255,0.05); border-radius: 12px; }
        .stat .stat-value { font-size: 1.5rem; }
        .stat.correct .stat-value { color: #2ecc71; }
        .stat.wrong .stat-value { color: #e74c3c; }
        .stat.streak .stat-value { color: #f39c12; }
        .progress-container { margin-bottom: 25px; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #1abc9c, #16a085); border-radius: 3px; transition: width 0.3s; }
        .mode-toggle { display: flex; gap: 8px; margin-bottom: 20px; }
        .mode-btn {
            flex: 1; padding: 10px; border: 2px solid rgba(255,255,255,0.15);
            border-radius: 10px; background: transparent; color: #888;
            font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .mode-btn.active { border-color: #1abc9c; color: #1abc9c; background: rgba(26,188,156,0.1); }
        .question-card {
            background: rgba(255,255,255,0.05); border-radius: 20px;
            padding: 30px; margin-bottom: 20px; text-align: center;
        }
        .question-label { font-size: 0.85rem; color: #888; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 2px; }
        .question-swedish { font-size: 1.6rem; font-weight: bold; line-height: 1.5; }
        .input-area { margin-bottom: 15px; }
        .answer-input {
            width: 100%; padding: 16px; font-size: 1.2rem;
            border: 2px solid rgba(255,255,255,0.2); border-radius: 12px;
            background: rgba(255,255,255,0.05); color: #fff;
            text-align: center; outline: none; transition: all 0.3s;
        }
        .answer-input:focus { border-color: #1abc9c; }
        .answer-input.correct { border-color: #2ecc71; background: rgba(46, 204, 113, 0.2); }
        .answer-input.wrong { border-color: #e74c3c; background: rgba(231, 76, 60, 0.2); }
        .hint-buttons { display: flex; gap: 8px; margin-bottom: 15px; }
        .hint-btn {
            flex: 1; padding: 10px 8px; border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px; background: transparent; color: #888;
            font-size: 0.8rem; cursor: pointer; transition: all 0.2s;
        }
        .hint-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
        .hint-btn.used { opacity: 0.5; pointer-events: none; }
        .hint-display {
            text-align: center; padding: 12px; border-radius: 10px;
            margin-bottom: 15px; display: none;
            background: rgba(26,188,156,0.15); color: #1abc9c;
        }
        .hint-display.show { display: block; }
        .check-btn, .next-btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            background: linear-gradient(90deg, #1abc9c, #16a085);
            color: #fff; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s;
        }
        .check-btn:hover, .next-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .next-btn { display: none; }
        .next-btn.show { display: block; }
        .feedback { text-align: center; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: none; }
        .feedback.show { display: block; }
        .feedback.correct { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .feedback.wrong { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .keyboard-hints { text-align: center; color: #555; font-size: 0.8rem; margin-top: 15px; }
        .keyboard-hints kbd { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 4px; margin: 0 2px; }
        .results { text-align: center; padding: 40px 20px; background: rgba(255,255,255,0.05); border-radius: 20px; display: none; }
        .results.show { display: block; }
        .results h2 { font-size: 1.8rem; margin-bottom: 20px; }
        .results-stats { display: flex; justify-content: center; gap: 30px; margin: 25px 0; }
        .results-stat { text-align: center; }
        .results-stat-value { font-size: 2.5rem; font-weight: bold; }
        .results-stat-label { color: #888; font-size: 0.9rem; }
        .restart-btn {
            padding: 16px 40px; border: none; border-radius: 15px;
            font-size: 1rem; cursor: pointer;
            background: linear-gradient(90deg, #1abc9c, #16a085);
            color: #fff; font-weight: 600; margin-top: 15px; transition: all 0.3s;
        }
        .restart-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        @media (max-width: 500px) {
            .container { padding: 15px; }
            header h1 { font-size: 2rem; }
            .question-swedish { font-size: 1.3rem; }
            .hint-btn { font-size: 0.75rem; padding: 8px 4px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="category-view" id="categoryView">
            <a href="index.html" class="back-btn"><span>&larr;</span> Huvudmeny</a>
            <header>
                <h1>Meningstr√§ning</h1>
                <p>√ñvers√§tt meningar fr√•n svenska till spanska</p>
            </header>
            <div class="stats-overview">
                <div class="stat-card"><div class="stat-value sessions" id="totalSessions">0</div><div class="stat-label">√ñvningar</div></div>
                <div class="stat-card"><div class="stat-value correct" id="totalCorrect">0</div><div class="stat-label">R√§tt</div></div>
                <div class="stat-card"><div class="stat-value streak" id="accuracy">0%</div><div class="stat-label">Tr√§ffs√§kerhet</div></div>
            </div>
            <div class="main-buttons">
                <button class="main-btn primary" id="practiceAllBtn">√ñva alla</button>
                <button class="main-btn secondary" id="randomBtn">Slumpa</button>
            </div>
            <div class="section-title">Kategorier</div>
            <div class="categories-list" id="categoriesList"></div>
        </div>

        <div class="exercise-view" id="exerciseView">
            <button class="back-btn" id="backToCategories"><span>&larr;</span> Tillbaka</button>
            <div class="exercise-header">
                <div class="exercise-title" id="exerciseTitle">Kategori</div>
                <div class="exercise-progress-text" id="exerciseProgressText">1/10</div>
            </div>
            <div class="stats-bar">
                <div class="stat correct"><div class="stat-value" id="correctCount">0</div><div class="stat-label">R√§tt</div></div>
                <div class="stat wrong"><div class="stat-value" id="wrongCount">0</div><div class="stat-label">Fel</div></div>
                <div class="stat streak"><div class="stat-value" id="currentStreak">0</div><div class="stat-label">Streak</div></div>
            </div>
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="lenient" id="modeLenient">Sn√§ll (utan accenter)</button>
                <button class="mode-btn" data-mode="strict" id="modeStrict">Strikt (med accenter)</button>
            </div>
            <div class="progress-container">
                <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
            </div>
            <div class="question-card">
                <div class="question-label">√ñvers√§tt till spanska</div>
                <div class="question-swedish" id="questionSwedish">Hej!</div>
            </div>
            <div class="input-area">
                <input type="text" class="answer-input" id="answerInput" placeholder="Skriv p√• spanska..." autocomplete="off">
            </div>
            <div class="hint-buttons">
                <button class="hint-btn" id="hint1Btn">F√∂rsta ordet</button>
                <button class="hint-btn" id="hint2Btn">Ordbank</button>
                <button class="hint-btn" id="hint3Btn">Visa svar</button>
            </div>
            <div class="hint-display" id="hintDisplay"></div>
            <div class="feedback" id="feedback"></div>
            <button class="check-btn" id="checkBtn">Kolla svar</button>
            <button class="next-btn" id="nextBtn">N√§sta &rarr;</button>
            <div class="keyboard-hints"><kbd>Enter</kbd> Kolla/N√§sta</div>
            <div class="results" id="resultsScreen">
                <h2>Bra jobbat!</h2>
                <div class="results-stats">
                    <div class="results-stat"><div class="results-stat-value" id="finalCorrect" style="color: #2ecc71;">0</div><div class="results-stat-label">R√§tt</div></div>
                    <div class="results-stat"><div class="results-stat-value" id="finalWrong" style="color: #e74c3c;">0</div><div class="results-stat-label">Fel</div></div>
                    <div class="results-stat"><div class="results-stat-value" id="finalPercent" style="color: #f39c12;">0%</div><div class="results-stat-label">Resultat</div></div>
                </div>
                <button class="restart-btn" id="restartBtn">K√∂r igen!</button>
                <br><button class="back-btn" id="backFromResults" style="margin-top: 15px;">&larr; V√§lj annan kategori</button>
            </div>
        </div>
    </div>

    <script>
        const exerciseData = {
            "saludos": {
                "name": "H√§lsningar", "icon": "üëã", "color": "#f39c12",
                "items": [
                    {"sv": "Hej!", "es": "¬°Hola!", "alternatives": ["Hola"]},
                    {"sv": "Hur √§r det?", "es": "¬øQu√© tal?", "alternatives": ["Que tal"]},
                    {"sv": "Hur m√•r du?", "es": "¬øC√≥mo est√°s?", "alternatives": ["Como estas"]},
                    {"sv": "God morgon!", "es": "¬°Buenos d√≠as!", "alternatives": ["Buenos dias", "Buenos d√≠as"]},
                    {"sv": "God kv√§ll!", "es": "¬°Buenas noches!", "alternatives": ["Buenas noches"]},
                    {"sv": "Mycket bra, tack", "es": "Muy bien, gracias", "alternatives": []},
                    {"sv": "Vi ses!", "es": "¬°Hasta luego!", "alternatives": ["Hasta luego"]},
                    {"sv": "Hejd√•", "es": "Adi√≥s", "alternatives": ["Adios"]},
                    {"sv": "Trevligt att tr√§ffas", "es": "Mucho gusto", "alternatives": ["Encantado", "Encantada"]}
                ]
            },
            "presentacion": {
                "name": "Presentera dig", "icon": "üó£Ô∏è", "color": "#e67e22",
                "items": [
                    {"sv": "Jag heter Johan", "es": "Me llamo Johan", "alternatives": ["Soy Johan"]},
                    {"sv": "Jag √§r fr√•n Sverige", "es": "Soy de Suecia", "alternatives": []},
                    {"sv": "Jag √§r 30 √•r", "es": "Tengo 30 a√±os", "alternatives": ["Tengo treinta a√±os"]},
                    {"sv": "Jag bor i Palma", "es": "Vivo en Palma", "alternatives": []},
                    {"sv": "Var kommer du ifr√•n?", "es": "¬øDe d√≥nde eres?", "alternatives": ["De donde eres"]},
                    {"sv": "Vad heter du?", "es": "¬øC√≥mo te llamas?", "alternatives": ["Como te llamas"]},
                    {"sv": "Jag √§r svensk", "es": "Soy sueco", "alternatives": []}
                ]
            },
            "familia": {
                "name": "Familjen", "icon": "üë®‚Äçüë©‚Äçüëß", "color": "#9b59b6",
                "items": [
                    {"sv": "Min pappa heter Pedro", "es": "Mi padre se llama Pedro", "alternatives": []},
                    {"sv": "Min mamma √§r Mar√≠a", "es": "Mi madre es Mar√≠a", "alternatives": []},
                    {"sv": "Jag har en bror", "es": "Tengo un hermano", "alternatives": []},
                    {"sv": "Jag har en syster", "es": "Tengo una hermana", "alternatives": []},
                    {"sv": "Min son √§r 5 √•r", "es": "Mi hijo tiene 5 a√±os", "alternatives": ["Mi hijo tiene cinco a√±os"]},
                    {"sv": "Min dotter √§r l√•ng", "es": "Mi hija es alta", "alternatives": []}
                ]
            },
            "verbos": {
                "name": "Verb (grundl√§ggande)", "icon": "üìù", "color": "#8e44ad",
                "items": [
                    {"sv": "Jag √§r svensk", "es": "Soy sueco", "alternatives": []},
                    {"sv": "Jag √§r tr√∂tt", "es": "Estoy cansado", "alternatives": ["Estoy cansada"]},
                    {"sv": "Jag har tv√• barn", "es": "Tengo dos hijos", "alternatives": []},
                    {"sv": "Jag pratar spanska", "es": "Hablo espa√±ol", "alternatives": []},
                    {"sv": "Jag jobbar i Barcelona", "es": "Trabajo en Barcelona", "alternatives": []},
                    {"sv": "Jag gillar musik", "es": "Me gusta la m√∫sica", "alternatives": ["Me gusta la musica"]},
                    {"sv": "Jag bor i Spanien", "es": "Vivo en Espa√±a", "alternatives": ["Vivo en Espana"]},
                    {"sv": "Jag √§ter lunch", "es": "Como el almuerzo", "alternatives": ["Almuerzo"]}
                ]
            },
            "colores": {
                "name": "F√§rger", "icon": "üé®", "color": "#2ecc71",
                "items": [
                    {"sv": "Himlen √§r bl√•", "es": "El cielo es azul", "alternatives": []},
                    {"sv": "Gr√§set √§r gr√∂nt", "es": "La hierba es verde", "alternatives": []},
                    {"sv": "Solen √§r gul", "es": "El sol es amarillo", "alternatives": []},
                    {"sv": "Sn√∂n √§r vit", "es": "La nieve es blanca", "alternatives": []},
                    {"sv": "Kolet √§r svart", "es": "El carb√≥n es negro", "alternatives": ["El carbon es negro"]}
                ]
            },
            "emociones": {
                "name": "K√§nslor", "icon": "üòä", "color": "#e74c3c",
                "items": [
                    {"sv": "Jag √§r glad", "es": "Estoy contento", "alternatives": ["Estoy contenta"]},
                    {"sv": "Jag √§r ledsen", "es": "Estoy triste", "alternatives": []},
                    {"sv": "Jag √§r arg", "es": "Estoy enfadado", "alternatives": ["Estoy enfadada"]},
                    {"sv": "Jag m√•r bra", "es": "Estoy bien", "alternatives": []},
                    {"sv": "Jag m√•r d√•ligt", "es": "Estoy mal", "alternatives": []},
                    {"sv": "Jag √§r sjuk", "es": "Estoy enfermo", "alternatives": ["Estoy enferma"]}
                ]
            },
            "numeros": {
                "name": "Siffror", "icon": "#Ô∏è‚É£", "color": "#3498db",
                "items": [
                    {"sv": "Jag √§r 25 √•r", "es": "Tengo veinticinco a√±os", "alternatives": ["Tengo 25 a√±os"]},
                    {"sv": "Det kostar 10 euro", "es": "Cuesta diez euros", "alternatives": ["Cuesta 10 euros"]},
                    {"sv": "Jag har tre br√∂der", "es": "Tengo tres hermanos", "alternatives": []},
                    {"sv": "Det finns tv√• katter", "es": "Hay dos gatos", "alternatives": []},
                    {"sv": "Klockan √§r fem", "es": "Son las cinco", "alternatives": []}
                ]
            }
        };

        const categoryGroups = {
            "grundlaggande": {
                name: "Grundl√§ggande",
                icon: "üìö",
                categories: ["saludos", "presentacion", "familia", "verbos", "colores", "emociones", "numeros"]
            }
        };

        let questions = [];
        let currentIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let streak = 0;
        let currentCategory = null;
        let hasAnswered = false;
        let accentMode = 'lenient';
        let usedHint3 = false;

        const categoryView = document.getElementById('categoryView');
        const exerciseView = document.getElementById('exerciseView');
        const categoriesList = document.getElementById('categoriesList');
        const answerInput = document.getElementById('answerInput');
        const feedback = document.getElementById('feedback');
        const checkBtn = document.getElementById('checkBtn');
        const nextBtn = document.getElementById('nextBtn');
        const resultsScreen = document.getElementById('resultsScreen');
        const hintDisplay = document.getElementById('hintDisplay');

        function normalize(str) {
            return str.toLowerCase().trim()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[¬°¬ø!?.,]/g, '');
        }

        function strictNormalize(str) {
            return str.toLowerCase().trim()
                .replace(/[!?.,]/g, '');
        }

        function checkMatch(userAnswer, correctAnswer, alternatives) {
            const allAnswers = [correctAnswer, ...alternatives];

            if (accentMode === 'lenient') {
                const normalizedUser = normalize(userAnswer);
                return allAnswers.some(ans => normalize(ans) === normalizedUser);
            } else {
                const normalizedUser = strictNormalize(userAnswer);
                return allAnswers.some(ans => strictNormalize(ans) === normalizedUser);
            }
        }

        function createCategoryItem(key, categoryProgress) {
            const cat = exerciseData[key];
            const progress = categoryProgress[key] || 0;
            const circumference = 2 * Math.PI * 18;
            const offset = circumference - (progress / 100) * circumference;
            const item = document.createElement('div');
            item.className = 'category-item';
            item.innerHTML = `
                <div class="category-icon" style="background: ${cat.color}20; color: ${cat.color};">${cat.icon}</div>
                <div class="category-info"><div class="category-name">${cat.name}</div><div class="category-count">${cat.items.length} meningar</div></div>
                <div class="progress-circle"><svg width="45" height="45"><circle class="bg" cx="22.5" cy="22.5" r="18"></circle><circle class="progress" cx="22.5" cy="22.5" r="18" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" style="stroke: ${cat.color}"></circle></svg></div>
            `;
            item.addEventListener('click', () => startExercise(key));
            return item;
        }

        function initCategories() {
            const saved = JSON.parse(localStorage.getItem('spanishSentencePractice') || '{}');
            const categoryProgress = saved.categoryProgress || {};
            const expandedGroups = JSON.parse(localStorage.getItem('spanishSentencePracticeExpanded') || '[]');

            Object.keys(categoryGroups).forEach(groupKey => {
                const group = categoryGroups[groupKey];
                const totalItems = group.categories.reduce((sum, catKey) => sum + (exerciseData[catKey]?.items.length || 0), 0);

                const groupEl = document.createElement('div');
                groupEl.className = 'category-group' + (expandedGroups.includes(groupKey) ? ' expanded' : '');
                groupEl.dataset.group = groupKey;

                const header = document.createElement('div');
                header.className = 'category-group-header';
                header.innerHTML = `
                    <div class="category-group-title"><span class="group-icon">${group.icon}</span>${group.name}</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span class="category-group-count">${group.categories.length} kategorier ¬∑ ${totalItems} meningar</span>
                        <span class="category-group-arrow">‚ñº</span>
                    </div>
                `;
                header.addEventListener('click', () => toggleGroup(groupKey));

                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'category-group-items';

                group.categories.forEach(catKey => {
                    if (exerciseData[catKey]) {
                        itemsContainer.appendChild(createCategoryItem(catKey, categoryProgress));
                    }
                });

                groupEl.appendChild(header);
                groupEl.appendChild(itemsContainer);
                categoriesList.appendChild(groupEl);
            });

            updateOverviewStats();
        }

        function toggleGroup(groupKey) {
            const groupEl = document.querySelector(`.category-group[data-group="${groupKey}"]`);
            groupEl.classList.toggle('expanded');
            const expandedGroups = [];
            document.querySelectorAll('.category-group.expanded').forEach(g => expandedGroups.push(g.dataset.group));
            localStorage.setItem('spanishSentencePracticeExpanded', JSON.stringify(expandedGroups));
        }

        function updateOverviewStats() {
            const saved = JSON.parse(localStorage.getItem('spanishSentencePractice') || '{}');
            document.getElementById('totalSessions').textContent = saved.sessions || 0;
            document.getElementById('totalCorrect').textContent = saved.totalCorrect || 0;
            const total = (saved.totalCorrect || 0) + (saved.totalWrong || 0);
            const acc = total > 0 ? Math.round((saved.totalCorrect / total) * 100) : 0;
            document.getElementById('accuracy').textContent = `${acc}%`;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startExercise(category) {
            currentCategory = category;
            let items = category === 'all'
                ? Object.values(exerciseData).flatMap(c => c.items)
                : exerciseData[category].items;
            questions = shuffle([...items]);
            currentIndex = 0; correctCount = 0; wrongCount = 0; streak = 0;
            const title = category === 'all' ? 'Alla kategorier' : exerciseData[category].name;
            document.getElementById('exerciseTitle').textContent = title;
            categoryView.classList.add('hidden');
            exerciseView.classList.add('active');
            resultsScreen.classList.remove('show');
            displayQuestion();
        }

        function displayQuestion() {
            if (currentIndex >= questions.length) { showResults(); return; }
            hasAnswered = false;
            usedHint3 = false;
            const q = questions[currentIndex];
            document.getElementById('questionSwedish').textContent = q.sv;
            answerInput.value = '';
            answerInput.className = 'answer-input';
            answerInput.disabled = false;
            answerInput.focus();
            feedback.classList.remove('show', 'correct', 'wrong');
            hintDisplay.classList.remove('show');
            checkBtn.style.display = 'block';
            nextBtn.classList.remove('show');
            // Reset hint buttons
            document.querySelectorAll('.hint-btn').forEach(btn => btn.classList.remove('used'));
            updateProgress();
        }

        function showHint(level) {
            const q = questions[currentIndex];
            const btn = document.getElementById(`hint${level}Btn`);
            btn.classList.add('used');

            if (level === 1) {
                const firstWord = q.es.replace(/^[¬°¬ø]/, '').split(' ')[0];
                hintDisplay.textContent = `F√∂rsta ordet: ${firstWord}...`;
            } else if (level === 2) {
                const words = q.es.replace(/[¬°¬ø!?.,]/g, '').split(' ');
                shuffle(words);
                hintDisplay.textContent = `Ordbank: ${words.join(' ¬∑ ')}`;
            } else if (level === 3) {
                hintDisplay.textContent = `Svar: ${q.es}`;
                usedHint3 = true;
            }
            hintDisplay.classList.add('show');
        }

        function checkAnswer() {
            if (hasAnswered) return;
            const userAnswer = answerInput.value.trim();
            const q = questions[currentIndex];
            hasAnswered = true;
            answerInput.disabled = true;

            if (!usedHint3 && checkMatch(userAnswer, q.es, q.alternatives || [])) {
                correctCount++; streak++;
                answerInput.classList.add('correct');
                feedback.textContent = 'R√§tt!';
                feedback.className = 'feedback show correct';
            } else {
                wrongCount++; streak = 0;
                answerInput.classList.add('wrong');
                feedback.textContent = `Fel! R√§tt svar: ${q.es}`;
                feedback.className = 'feedback show wrong';
            }
            checkBtn.style.display = 'none';
            nextBtn.classList.add('show');
            updateStats();
        }

        function nextQuestion() { currentIndex++; displayQuestion(); }

        function updateProgress() {
            const progress = (currentIndex / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('exerciseProgressText').textContent = `${currentIndex + 1}/${questions.length}`;
        }

        function updateStats() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('currentStreak').textContent = streak;
        }

        function showResults() {
            document.getElementById('finalCorrect').textContent = correctCount;
            document.getElementById('finalWrong').textContent = wrongCount;
            const total = correctCount + wrongCount;
            const percent = total > 0 ? Math.round((correctCount / total) * 100) : 0;
            document.getElementById('finalPercent').textContent = `${percent}%`;
            resultsScreen.classList.add('show');
            saveProgress(percent);
        }

        function saveProgress(percent) {
            const saved = JSON.parse(localStorage.getItem('spanishSentencePractice') || '{}');
            saved.totalCorrect = (saved.totalCorrect || 0) + correctCount;
            saved.totalWrong = (saved.totalWrong || 0) + wrongCount;
            saved.sessions = (saved.sessions || 0) + 1;
            if (currentCategory && currentCategory !== 'all') {
                saved.categoryProgress = saved.categoryProgress || {};
                saved.categoryProgress[currentCategory] = Math.max(saved.categoryProgress[currentCategory] || 0, percent);
            }
            localStorage.setItem('spanishSentencePractice', JSON.stringify(saved));
        }

        function backToCategories() {
            exerciseView.classList.remove('active');
            categoryView.classList.remove('hidden');
            resultsScreen.classList.remove('show');
            updateOverviewStats();
            categoriesList.innerHTML = '';
            initCategories();
        }

        function setAccentMode(mode) {
            accentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        // Event listeners
        document.getElementById('practiceAllBtn').addEventListener('click', () => startExercise('all'));
        document.getElementById('randomBtn').addEventListener('click', () => startExercise('all'));
        document.getElementById('backToCategories').addEventListener('click', backToCategories);
        document.getElementById('backFromResults').addEventListener('click', backToCategories);
        document.getElementById('restartBtn').addEventListener('click', () => { resultsScreen.classList.remove('show'); startExercise(currentCategory); });
        document.getElementById('modeLenient').addEventListener('click', () => setAccentMode('lenient'));
        document.getElementById('modeStrict').addEventListener('click', () => setAccentMode('strict'));
        document.getElementById('hint1Btn').addEventListener('click', () => showHint(1));
        document.getElementById('hint2Btn').addEventListener('click', () => showHint(2));
        document.getElementById('hint3Btn').addEventListener('click', () => showHint(3));
        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', nextQuestion);
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { hasAnswered ? nextQuestion() : checkAnswer(); }
        });
        initCategories();
    </script>
</body>
</html>
